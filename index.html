<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>1</title>
<! based heavily on sankey example http://bost.ocks.org/mike/sankey/>
<style>

body {
  font-size: 12pt;
  font-family: "Helvetica Neue",Arial,sans-serif;
  stroke: #777;
}

#chart {
  height: 600px;
}

.node rect {
  cursor: move;
  fill-opacity: .9;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

.link:hover {
  stroke-opacity: .5;
}

.text {
  font-size: 14px;
  font-family: "Helvetica Neue",Arial,sans-serif;
  stroke: #888;
}

.firstnode {
  stroke: #1f77b4;
}

.secondnode {
  stroke: #ff7f0e;
}

</style>
<body>

<h1>Citibike New York City - Morning rush in June 2015</h1>
<h2>Citibike trips, as flows between neighborhoods</h2>
The chart shows that the highest departures are from <span class="body.firstnode">Chelsea</span> and the Lower East Side but the destinations are very different.
<p>About half of the 
<span style=.firstnode>Chelsea</span> departures stay within <span class="firstnode">Chelsea</span> while only a quarter of the <span class=".text.secondnode">Lower East Side</span> departures stay within that neighborhood. The <span class=".text.secondnode">Lower East Side</span> is second in departures but it is only about half the number of arrival as departures, suggesting that it is mostly residential.
<p>To explore, mouse over the departures on the left or the arrivals on the right.
<p>
<p id="chart">
<script src="http://d3js.org/d3.v2.min.js?2.9.1"></script>
<script src="citibike_sankey.js"></script>
<script>

var margin = {top: 40, right: 10, bottom: 10, left: 100},
    width = 420 - margin.left - margin.right,
    height = 520 - margin.top - margin.bottom;

var formatNumber = d3.format(",.0f"),
    format = function(d) { return formatNumber(d) ; };

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var sankey = d3.sankey()
    .nodeWidth(18)
    .nodePadding(10)
    .size([width, height]);

var path = sankey.link();

// parent for the node structure
var bike_rides = {}

// currentlt no action on mousemove
function mouseMove() {} ;
 
var color_scale = d3.scale.category10() ;
function node_color (node) {
  return color_scale(node.color_index ) ;
} ;

var show_opacity = 0.4,
    hide_opacity = "0.04" ;


// used to show the initial state which emphasizese certain stations
function show_graded_opacity(d) {
    if (d.source.name == "Chelsea" | d.source.name == "Lower East Side") {
      return 0.6;
    } else {
      return 0.2;
    }
}

// debugger;
d3.json("station_trips_sankey.json", function(bike_rides) {

  sankey
      .nodes(bike_rides.nodes)
      .links(bike_rides.links)
      .layout(32);

  // Axis titles - From 
  svg.append("text")
    .attr("x", 0)
    .attr("y", -12)
    .attr("font-size", "1.5em")
    .attr("font-weight", "bold")
    .text("From") ;

  // Axis titles - To
  svg.append("text")
    .attr("x", width)
    .attr("y", -12)
    .attr("text-anchor", "end")
    .attr("font-size", "1.5em")
    .attr("font-weight", "bold")
    .text("To") ;

  // Links - as paths
  var link = svg.append("g").selectAll(".link")
      .data(bike_rides.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("link_source_id", function(d) {return d.source.id;})
      .attr("link_target_id", function(d) {return d.target.id;})
      .attr("d", path)
      .style("fill", "none")
      .style("stroke-opacity", function(d) {return show_graded_opacity (d); })
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .style("stroke", function(d) { return d.color = node_color(d.source); })
      .sort(function(a, b) { return b.dy - a.dy; })
      .on("mouseover", function (d) {return linkSubSet(d.source.id, bike_rides.nodes.length) ; }) 
      .on("mousemove", mouseMove()) 
      .on("mouseout",  function () {return linkSubSet(-1, bike_rides.nodes.length); })
  link.append("title")
      .text(function(d) { return d.source.name + " â†’ " + d.target.name + "\n" + format(d.value) + " rides\n" + 
        Math.round(100.0*d.value/d.source.value) + "% of " + 
        d.source.name + " departures" ;  });

 // Nodes - as rectangles
 var node = svg.append("g").selectAll(".node")
      .data(bike_rides.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .on("mouseover", function (d) {return linkSubSet(d.id, bike_rides.nodes.length) ; }) 
      .on("mousemove", mouseMove()) 
      .on("mouseout",  function ()  {return linkSubSet(-1, bike_rides.nodes.length) ; });
  
  node.append("rect")
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
      .style("fill", function(d) { return d.color = node_color(d) ; })
      .style("stroke", function(d) { return d3.rgb(d.color).darker(0.1); })
    .append("title")
      .text(function(d) { return d.name + "\n" + format(d.value) + " rides"; });

  // Text for the node labels
  node.append("text")
      .attr("x", -6)
      .attr("y", function(d) { return d.dy / 2; })
      .attr("dy", "0.2em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
    .filter(function(d) { return d.x < width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start");

  // determines a subset of source links attached to this node
  // ransition to highlight selected and fade the not selected
  function linkSubSet(index, nodes_length) {

    function make_other_selectors(ix, count) {
       var ixx = (ix+1)%count ;
       var sel = ""
       var delim = ""
       while (ixx != ix) {
        sel = sel + delim + make_selector(ixx) 
        delim = ","
        ixx = (ixx+1)%count
       }
       // console.log("Selectors: " + sel)
       return sel;
    }
    // selects links to or from this index (comma is the boolean OR)
    function make_selector(i) {
       var sel = '[link_source_id="' + i + '"],' +
                 '[link_target_id="' + i + '"]' ;
       return sel
    }

    //if pointing at an item
    var hide_selector, show_selector ;
    if (index >= 0) { 
      show_selector = make_selector(index) ;          // show this item
      hide_selector = make_other_selectors(index, nodes_length); // hide others
    } else { // show all
      show_selector = ".link" ; // show all
      hide_selector = "" ;  // hide nothing
    }
    // show the selected 
    var t2 = svg.transition()
        .duration(0)
        .delay(0);
    // console.log("Visible: " + show_selector);
    t2.selectAll(show_selector )
      .style("stroke-opacity", show_opacity)
  //    .attr("visibility", "visible")

    // hide the other (unless its show all)
    var delay_ms = 0;
    if (hide_selector != "") {
      var t1 = svg.transition()
  //        .duration()
          .delay(function (d, i) {delay_ms+=200;console.log("delay "+delay_ms);return delay_ms})
      //  console.log("Hidden: " + hide_selector);
      t1.selectAll(hide_selector)    
          .style("stroke-opacity", hide_opacity)
    //    .attr("visibility", "hidden")
    }
    // show the selected 
    var t3 = svg.transition()
        .duration(200)
        .delay(0);
    // console.log("Visible: " + show_selector);
    t3.selectAll(show_selector )
     .style("stroke-opacity", show_opacity)
    //  .attr("visibility", "visible")
  } }  );

</script>
</body>