<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title>Citibike NYC Morning Rush Flow</title>
<! based heavily on sankey example http://bost.ocks.org/mike/sankey/>
<style>

body {
  font-size: 12pt;
  font-family: "Helvetica Neue",Arial,sans-serif;
  color: #888;
  margin-top:    20px;
  margin-right:  20px;
  margin-bottom: 20px;
  margin-left:   20px;
}

#chart {
  height: 600px;
}

.node rect {
  cursor: move;
  fill-opacity: .8;
  shape-rendering: crispEdges;
}

.node text {
  pointer-events: none;
  color: #888
}

.link {
  fill: none;
  stroke: #000;
  stroke-opacity: .2;
}

.link:hover {
  stroke-opacity: .5;
}

.text {
  font-size: 14px;
  font-family: "Helvetica Neue",Arial,sans-serif;
  color: #888;
}

.axislabel text {
  font-weight: bold;
  font-size: 120% ;
  color: #888;
}
.nodelabel text {
  font-weight: bold;
  font-size: 100% ;
  color: #888;
}

.node_ref {
  font-size: 110%;
  color: #FFF;
}

</style>
<body>
<h1>Citibike New York City - Morning Rush - June 2015</h1>
<h2>Citibike trips, as flows between neighborhoods</h2>
<br>The <a href="http://www.citibikenyc.com/">Citibike bike sharing service</a> in New York City is a robust commute alternative, despite its growing pains. This interactive chart, based on <a href="http://www.citibikenyc.com/system-data">trip histories</a>, shows the number of rides as flows between the departure and arrival neighborhoods for morning rush hours.<br><br>
<table style="width:100%">
  <tr style="vertical-align:top">
    <td style="width:35% padding:100px vertical-align:top">
      <p><b>Busiest</b>
      <br>The busiest departure neighborhoods are <span class="node_ref">Chelsea</span> and the <span class="node_ref">Lower East</span> with about 47,000 and 31,000 departures respectively. The least busy neighborhood is <span class="node_ref">Upper East</span>, with only 5,500 departures.
      <p><b>Within the Neighborhood</b>
      <br>About 45% of
      Chelsea departures stay within the neighborhood compared to only 12% for the Lower East This can be seen in the far broader fan-out of the <span class="node_ref">Lower East</span> flows and the thick intra-neighborhood flow of <span class="node_ref">Chelsea</span>. 
      63% of all rides from <span class="node_ref">Brooklyn</span> stay within the neighborhood because the Hudson River separates it from the other neighborhoods. Impressively, the remaining riders cross the Brooklyn Bridge.
      <p><b>Imbalance</b><br>The <span class="node_ref">Lower East</span> shows a strong departure/arrival imbalance with 78% of departures ending elsewhere, suggesting that it is a mostly residential neighborhood and not a work destination. <span class="node_ref">Lower Manhattan</span> is clearly more business than residential because arrivals are twice the departures, although the total rides are relatively small. <span class="node_ref">Gramercy Park</span> and <span class="node_ref">Village/Soho</span> have small gains in arrivals vs. departures. 
      <p><b>Bikes Gained/Lost</b><br>The largest gainer is <span class="node_ref">Lower Manhattan</span> which ends with 93% more bikes than it starts with. The <span class="node_ref">Lower East</span> ends with 51% fewer bikes.
      <br><br><b>Explore by moving the mouse over the departures, the arrivals or the flows.</b>
    </td>
    <td style="width:10%">
    </td>
    <td style="width:55% padding:100px outline:thin">
      <p id="chart">
    </td>
  </tr>
  <tr>
    <td>
    </td>
    <td></td>
    <td id="totaltrips" style=""> 
    </td>


</table>
<p>Flow layout by <a href="http://bost.ocks.org/mike/sankey/">d3 Sankey</a>
<br>Colors by <a href="http://colorbrewer2.org/?type=qualitative&scheme=Set2&n=7">colorbrewer.org</a>
</body>
<script src="http://d3js.org/d3.v2.min.js?2.9.1"></script>
<script src="citibike_sankey.js"></script>
<script>

// marging an plt sizes 
var margin = {top: 5, right: 150, bottom: 50, left: 150},

    width = 600 - margin.left - margin.right,
    height = 550 - margin.top - margin.bottom,
    centerx = 600 / 2 ;

// formatters
var formatNumber = d3.format(",.0f"),
    format = function(d) { return formatNumber(d) ; };

var formatPercent = d3.format(",.0%"),
    format = function(d) { return formatNumber(d) ; };

// format thecNodectooltip. 
var formatNodeTooltip =  function(d) { 
    if (d.node_type == "source") {
      t2 = formatNumber(d.value) + " departures, which is " ;
      t3 = formatPercent(d.value_fraction) + " of all departures\n" ;
      t4 = formatPercent(d.value_intra/d.value) + " of " + d.name + " departures stay in the neighborhood\n" ;
      t5 = formatPercent(1 - d.value_intra/d.value) + " of " + d.name + " departures end in other neighborhoods\n" ; 
      tt = d.name + "\n" + t2 + t3 + t4 + t5;
    } else {
      t2 = formatNumber(d.value) + " arrivals, which is " ;
      t3 = formatPercent(d.value_fraction) + " of all arrivals\n" ;
      change = d.value/d.assoc_node.value - 1
      t4 = "At end of morning rush, " + d.name + " has " + 
           formatPercent(Math.abs(change)) + ((change > 0) ? " more bikes" : " fewer bikes") ;
      tt = d.name + "\n" + t2 + t3 + t4;
    } ;
    // console.log(tt) ;
  return tt
};

// select the chart area
var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")")  ;

// select node references within the text
var node_refs = d3.selectAll(".node_ref") ;

// use the d3 sankey library 
var sankey = d3.sankey()
    .nodeWidth(40)
    .nodePadding(10)
    .size([width, height]);

// pglobals for the node and link structure
var path = sankey.link();
var rides = {}

// currently, no action on mousemove 
function mouseMove() {} ;
 

// color scales -- from colorbrewer.org
//var color_scale = d3.scale.category10() ;
var color_scale = d3.scale.ordinal()
  .domain([0, 1, 2, 3, 4, 5, 6])
  .range(['rgb(102,194,165)','rgb(252,141,98)','rgb(141,160,203)',
          'rgb(231,138,195)','rgb(166,216,84)','rgb(255,217,47)','rgb(229,196,148)']);
var color_scale_name = d3.scale.ordinal()
  .domain(["Chelsea", "Lower East", "Gramercy Park", "Village/Soho", "Brooklyn", 
           "Lower Manhattan", "Upper East"])
  .range(['rgb(102,194,165)','rgb(252,141,98)','rgb(141,160,203)',
         'rgb(231,138,195)','rgb(166,216,84)','rgb(255,217,47)','rgb(229,196,148)']);

function node_color (node) {
  color = color_scale_name(node.name )  ;
  return color ;
} ;

function node_color_by_name (node_name) {
    color = color_scale_name(node_name.trim())  ;

  return color ;
} ;

// opacities for show and hide as well as the initial state for
// selected statiosn
var show_opacity = 0.6,
    hide_opacity = "0.1" ;


// used to show the initial state which emphasizese certain stations
function show_graded_opacity(d) {
    if (d.source.name == "Chelsea" | d.source.name == "Lower East" | d.source.name == "Upper East" ) {
      return 0.6;
    } else {
      return 0.1;
    }
}

// debugger;
// d3 data driver
d3.json("station_trips_sankey.json", function(rides) {

  // build the nodes and links - calc totals
  sankey
      .nodes(rides.nodes)
      .links(rides.links)
      .layout(32);
  total_rides = d3.sum(rides.links, function(d) {return d.value; }) ;

  // link up corresponding source and target pairs using assoc_node
  // calulate fractions of totals ans updtae nodes
  neighborhood_count = rides.nodes.length / 2 ;
  first_source_node = rides.nodes[0] ;
  first_target_node = rides.nodes[neighborhood_count] ;
  for (ni = 0 ; ni<neighborhood_count; ni++ ) {
     // source nodes 
     rides.nodes[ni].assoc_node = rides.nodes[ni + neighborhood_count] ;
     rides.nodes[ni].value_fraction = rides.nodes[ni].value / total_rides ;
     // target nodes
    rides.nodes[ni + neighborhood_count].assoc_node = rides.nodes[ni] ;
    rides.nodes[ni + neighborhood_count].value_fraction = rides.nodes[ni + neighborhood_count].value / total_rides ;
  }

  // calculate the part of the value that stays in the node (neighborhood)
  rides.links.forEach( function(d) { 
       if (d.target == d.source.assoc_node) d.source.value_intra = d.value ;} )
  
  // Node Names that are mention in text are made live with node_ref class
  // Entered text (innerHTML) must match node name exactky
  node_refs
      .style("font-size",  "110%")
      .style("background-color", 
            function (d) { return node_color_by_name(this.innerHTML);})
      .on("mouseover", function (d) {
        return linkSubSet(rides.nodes.map(function (d) {return d.name}).indexOf(this.innerHTML), 
                          rides.nodes.length) ; }) 
      .on("mousemove", mouseMove()) 
      .on("mouseout",  function () {return linkSubSet(-1, rides.nodes.length); })
  
  // Axis titles - Departure 
  svg.append("text")
    .attr("x", first_source_node.x - 6)
    .attr("y", 12)
    .attr("text-anchor", "end")
    .attr("class", "axislabel")
    .style("fill", "#888")
    .style("font-weight", "bold")
    .text("DEPARTURES") 
    .on("mouseover",  function ()  {return linkSubSet(-1, rides.nodes.length) ; });

  // Axis titles - Arrival
  svg.append("text")
    .attr("x", first_target_node.x + sankey.nodeWidth() + 6)
    .attr("y", 12)
    .attr("text-anchor", "start")
    .attr("class", "axislabel")
    .style("font-weight", "bold")
    .style("fill", "#888")
    .text("ARRIVALS") ;

  // total rides 
  svg.append("text")
    .attr("x", width/2)
    .attr("y", height  + 40)
    .attr("text-anchor", "middle")
    .style("font-weight", "bold")
    .style("fill", "#888")
    .style("font-weight", "bold")
    .text(formatNumber(total_rides) + " Citibike NYC rides, 4 am to 10 am, June 2015") ;

  // Links - as paths
  var link = svg.append("g").selectAll(".link")
      .data(rides.links)
    .enter().append("path")
      .attr("class", "link")
      .attr("link_source_id", function(d) {return d.source.id;})
      .attr("link_target_id", function(d) {return d.target.id;})
      .attr("d", path)
      .style("fill", "none")
      .style("stroke-opacity", function(d) {return show_graded_opacity (d); })
      .style("stroke-width", function(d) { return Math.max(1, d.dy); })
      .style("stroke", function(d) { return d.color = node_color(d.source); })
      .sort(function(a, b) { return b.dy - a.dy; })
      .on("mouseover", function (d) {return linkSubSet(d.source.id, rides.nodes.length) ; }) 
      .on("mousemove", mouseMove()) 
      .on("mouseout", function(){return null;}) ;
      // .on("mouseout",  function () {return linkSubSet(-1, rides.nodes.length); });

  // Link - Tooltip
  link.append("title")
      .text(function(d) { return d.source.name + " → " + d.target.name + "\n" +
         format(d.value) + " rides, which is " + 
         formatPercent(d.value/total_rides) + " of all rides\n" +
         formatPercent(d.value/d.source.value) + " of rides from " + d.source.name + " end at " + d.target.name + "\n" +
         formatPercent(d.value/d.target.value) + " of rides ending at " + d.target.name + " start from " + d.source.name;  }) ;

 // Nodes - as rectangles plus tooltiip
 var node = svg.append("g").selectAll(".node")
      .data(rides.nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; })
      .on("mouseover", function (d) {return linkSubSet(d.id, rides.nodes.length) ; }) 
  
  node.append("rect")
      .style("fill", function(d) { return d.color = node_color(d) ; })
      .style("stroke", function(d) { return d3.rgb(d.color).darker(0.1); })
      .attr("height", function(d) { return d.dy; })
      .attr("width", sankey.nodeWidth())
    .append("title")
      .text(function(d) { return formatNodeTooltip(d); });

  // Text for the node labels
  node.append("text")
      .attr("class", "nodelabel")
      .attr("x", -6)
      .attr("y", function(d) { return 2 + d.dy / 2; })
      .attr("dy", "0.2em")
      .attr("text-anchor", "end")
      .attr("transform", null)
      .text(function(d) { return d.name; })
      .style("fill", "#888")
    .on("mouseover", function (d) {return linkSubSet(d.id, rides.nodes.length) ; }) 
    .filter(function(d) { return d.x > width / 2; })
      .attr("x", 6 + sankey.nodeWidth())
      .attr("text-anchor", "start")
;
// Text for the node percentages
  node.append("text")
      .attr("class", "nodepercent")
      .attr("x", sankey.nodeWidth()/2)
      .attr("y", function(d) { return 2 + d.dy / 2; })
      .attr("dy", "0.2em")
      .attr("text-anchor", "middle")
      .attr("transform", null)
      .text(function(d) { return formatPercent(d.value_fraction)})
      .style("font-size", "0.9em")
      .style("fill", "#777");

  // Determines a subset of source links attached to this node
  // Transition to highlight selected and fade the not selected
  // This is the fundamental mouseover selection function
  var selected_index ;
  function linkSubSet(index, nodes_length) {

    function make_other_selectors(ix, count) {
       var ixx = (ix+1)%count ;
       var sel = ""
       var delim = ""
       while (ixx != ix) {
        sel = sel + delim + make_selector(ixx) 
        delim = ","
        ixx = (ixx+1)%count
       }
       // console.log("Selectors: " + sel)
       return sel;
    }
    // selects links to or from this index (comma is the boolean OR)
    function make_selector(i) {
       var sel = '[link_source_id="' + i + '"],' +
                 '[link_target_id="' + i + '"]' ;
       return sel
    }

    // if the same as the cuurent then dont tranitysition
    // console.log("selecting " + index)
    if (index == selected_index) {
      return
    }
    selected_index=index;

    //if pointing at an item
    var hide_selector, show_selector ;
    if (index >= 0) { 
      show_selector = make_selector(index) ;          // show this item
      hide_selector = make_other_selectors(index, nodes_length); // hide others
    } else { // show all
      show_selector = ".link" ; // show all
      hide_selector = "" ;  // hide nothing
    }
    // show the selected 
    var t2 = svg.transition()
        .duration(0)
        .delay(0);
    // console.log("Visible: " + show_selector);
    t2.selectAll(show_selector )
      .style("stroke-opacity", show_opacity)
  //    .attr("visibility", "visible")

    // hide the other (unless its show all)
    var delay_ms = 0;
    if (hide_selector != "") {
      var t1 = svg.transition()
          .delay(function (d, i) {delay_ms+=200;return delay_ms})
      //  console.log("Hidden: " + hide_selector);
      t1.selectAll(hide_selector)    
          .style("stroke-opacity", hide_opacity)
    }
    // show the selected 
    var t3 = svg.transition()
        .duration(200)
        .delay(0);
    // console.log("Visible: " + show_selector);
    t3.selectAll(show_selector )
     .style("stroke-opacity", show_opacity)
  } }  );

</script>